<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ - CarRental</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .booking-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .car-summary {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .date-picker {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
        }
        .price-calculation {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .error-message {
            color: red;
            padding: 10px;
            border: 1px solid red;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/">üöó CarRental</a>
        <div class="navbar-nav">
            <a class="nav-link" href="/cars">‚Üê –ù–∞–∑–∞–¥ –∫ –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º</a>
        </div>
    </div>
</nav>

<div class="booking-container">
    <div class="text-center mb-4">
        <h1>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</h1>
        <p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã –∞—Ä–µ–Ω–¥—ã –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</p>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
    <div th:if="${error}" class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i>
        <span th:text="${error}">–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</span>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ -->
    <div class="car-summary" th:if="${car}">
        <div class="row align-items-center">
            <div class="col-md-4 text-center">
                <img th:src="${car.imageUrl} ?: '/images/cars/default-car.jpg'"
                     class="img-fluid rounded"
                     style="max-height: 200px; object-fit: cover;"
                     th:alt="${car.brand + ' ' + car.model}">
            </div>
            <div class="col-md-8">
                <h3 th:text="${car.brand + ' ' + car.model}"></h3>
                <p class="text-muted" th:text="${car.year + ' –≥–æ–¥ ‚Ä¢ ' + car.color}"></p>
                <div class="d-flex gap-2 mb-2 flex-wrap">
                    <span class="badge bg-primary" th:text="${car.fuelType}"></span>
                    <span class="badge bg-secondary" th:text="${car.transmission}"></span>
                    <span class="badge bg-info" th:text="${car.bodyType}"></span>
                    <span class="badge bg-warning" th:if="${car.engineCapacity}"
                          th:text="${car.engineCapacity} + ' –ª'"></span>
                    <span class="badge bg-success" th:if="${car.horsePower}"
                          th:text="${car.horsePower} + ' –ª.—Å.'"></span>
                </div>
                <h4 class="text-success" th:text="${#numbers.formatDecimal(car.pricePerDay, 0, 'DEFAULT', 2, 'DEFAULT')} + ' ‚ÇΩ/–¥–µ–Ω—å'"></h4>
            </div>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <!-- –§–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="date-picker" th:if="${car}">
        <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º book2 –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –±–µ–∑ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ -->
        <form th:action="@{/rentals/book2}" method="post" th:object="${rentalRequest}">
            <!-- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –°–¢–†–û–ö–ê: —É–±—Ä–∞—Ç—å th:field –∏ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ value -->
            <input type="hidden" name="carId" th:value="${car.id}">

            <div class="row mb-4">
                <div class="col-md-6">
                    <label class="form-label fw-bold">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –∞—Ä–µ–Ω–¥—ã</label>
                    <input type="datetime-local" name="startDate" th:field="*{startDate}"
                           class="form-control form-control-lg" required
                           th:min="${#temporals.format(#temporals.createToday(), 'yyyy-MM-dd')} + 'T00:00'">
                    <div class="form-text">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ - —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã</label>
                    <input type="datetime-local" name="endDate" th:field="*{endDate}"
                           class="form-control form-control-lg" required>
                    <div class="form-text">–î–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –∞—Ä–µ–Ω–¥—ã</div>
                </div>
            </div>

            <!-- –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ -->
            <div class="price-calculation text-center">
                <h5 class="mb-2">–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏</h5>
                <div class="d-flex justify-content-center align-items-center gap-3 flex-wrap">
                    <span id="daysCount">0 –¥–Ω–µ–π</span>
                    <span>√ó</span>
                    <span th:text="${#numbers.formatDecimal(car.pricePerDay, 0, 'DEFAULT', 2, 'DEFAULT')} + ' ‚ÇΩ/–¥–µ–Ω—å'"></span>
                    <span>=</span>
                    <h4 id="totalPrice" class="mb-0">0 ‚ÇΩ</h4>
                </div>
            </div>

            <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-primary btn-lg py-3">
                    <i class="bi bi-lightning-fill"></i> –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å
                </button>
                <a href="/cars" class="btn btn-outline-secondary">–û—Ç–º–µ–Ω–∞</a>
            </div>
        </form>
    </div>

    <!-- –ï—Å–ª–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω -->
    <div th:unless="${car}" class="alert alert-warning text-center">
        <h4>–ê–≤—Ç–æ–º–æ–±–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</h4>
        <p>–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.</p>
        <a href="/cars" class="btn btn-primary">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞—Ç–∞–ª–æ–≥—É</a>
    </div>

    <!-- –£—Å–ª–æ–≤–∏—è –∞—Ä–µ–Ω–¥—ã -->
    <div class="mt-4 p-3 bg-light rounded" th:if="${car}">
        <h5><i class="bi bi-info-circle"></i> –£—Å–ª–æ–≤–∏—è –∞—Ä–µ–Ω–¥—ã:</h5>
        <ul class="text-muted mb-0">
            <li>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫ –∞—Ä–µ–Ω–¥—ã - 1 –¥–µ–Ω—å</li>
            <li>–¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ª–æ–≥ –≤ —Ä–∞–∑–º–µ—Ä–µ 5000 ‚ÇΩ</li>
            <li>–ü—Ä–æ–±–µ–≥ –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</li>
            <li>–ü–æ–ª–Ω–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞ –≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å</li>
            <li>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞</li>
        </ul>
    </div>
</div>

<script>
    // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    function calculatePrice() {
        const startDateInput = document.querySelector('input[name="startDate"]');
        const endDateInput = document.querySelector('input[name="endDate"]');
        const pricePerDay = parseFloat([[${car?.pricePerDay}]] || 0);

        if (startDateInput && endDateInput && startDateInput.value && endDateInput.value) {
            const start = new Date(startDateInput.value);
            const end = new Date(endDateInput.value);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ—Å–ª–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞
            if (end <= start) {
                document.getElementById('daysCount').textContent = '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞—Ç—ã';
                document.getElementById('totalPrice').textContent = '0 ‚ÇΩ';
                return;
            }

            const diffTime = end - start;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            const days = diffDays > 0 ? diffDays : 1;
            const total = days * pricePerDay;

            document.getElementById('daysCount').textContent = days + ' ' + getDaysText(days);
            document.getElementById('totalPrice').textContent = total.toLocaleString('ru-RU') + ' ‚ÇΩ';
        }
    }

    // –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–∫–ª–æ–Ω–µ–Ω–∏–µ —Å–ª–æ–≤–∞ "–¥–µ–Ω—å"
    function getDaysText(days) {
        if (days % 10 === 1 && days % 100 !== 11) {
            return '–¥–µ–Ω—å';
        } else if ([2, 3, 4].includes(days % 10) && ![12, 13, 14].includes(days % 100)) {
            return '–¥–Ω—è';
        } else {
            return '–¥–Ω–µ–π';
        }
    }

    // –°–ª—É—à–∞—Ç–µ–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç
    document.addEventListener('DOMContentLoaded', function() {
        const startDateInput = document.querySelector('input[name="startDate"]');
        const endDateInput = document.querySelector('input[name="endDate"]');

        if (startDateInput) {
            startDateInput.addEventListener('change', function() {
                const startDate = new Date(this.value);

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è
                if (startDate && endDateInput) {
                    const minEndDate = new Date(startDate);
                    minEndDate.setDate(minEndDate.getDate() + 1);
                    endDateInput.min = minEndDate.toISOString().slice(0, 16);

                    // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–Ω—å—à–µ –Ω–æ–≤–æ–π –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ—ë
                    if (endDateInput.value && new Date(endDateInput.value) < minEndDate) {
                        endDateInput.value = '';
                    }
                }

                calculatePrice();
            });
        }

        if (endDateInput) {
            endDateInput.addEventListener('change', calculatePrice);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        calculatePrice();
    });

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    document.querySelector('form')?.addEventListener('submit', function(e) {
        const startDate = document.querySelector('input[name="startDate"]').value;
        const endDate = document.querySelector('input[name="endDate"]').value;

        if (!startDate || !endDate) {
            e.preventDefault();
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã');
            return;
        }

        const start = new Date(startDate);
        const end = new Date(endDate);

        if (end <= start) {
            e.preventDefault();
            alert('–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞');
            return;
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>